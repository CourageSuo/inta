var ck=0,hCookie=Backbone.View.extend({el:"#hlogin",template:_.template($("#tpHeader2").html()),initialize:function(){this.$el.append(this.template({name:this.model})),ck=0}}),nCookie=Backbone.View.extend({el:"#nlogin",template:_.template($("#tpHeader").html()),events:{"click #login":"loginContent"},loginContent:function(){var e=this;$.post("/helloworld/login",{userName:$(".logNum").val(),passWord:$(".logPass").val()},function(t){"nouser"===t||"incorrect"===t?alert("用户名或密码不正确"):(e.remove(),new hCookie({model:t}),ck=1)})},initialize:function(){this.$el.append(this.template())}});"no"===user?new nCookie:new hCookie({model:user});for(var itemContent=Backbone.Model.extend({default:{_id:"",icon:"",title:"",author:"",tag:"",readNumber:1,content:"",createdOn:"",category:""}}),itemComment=Backbone.Model.extend({urlRoot:"/helloworld/comment"}),listModel=listModel.reverse(),pinNum=10,listContent=Backbone.Collection.extend({model:itemContent}),allContent=new listContent,allContentCache=listModel,i=0;i<pinNum;i++)allContent.add(allContentCache[i]);var itemView=Backbone.View.extend({tagName:"li",template:_.template($("#listContent").html()),render:function(){return this.model.set("content",this.model.get("content").substring(0,68)+"..."),this.$el.html(this.template(this.model.toJSON())),this.changeColor(),this},changeColor:function(){switch(this.model.get("tag")){case"文章":this.$(".tagStyleList").css("background-color","#00A388");break;case"问题":this.$(".tagStyleList").css("background-color","#e67e22");break;case"学习资料":this.$(".tagStyleList").css("background-color","#27ae60");break;case"培训这些事儿":this.$(".tagStyleList").css("background-color","#9b59b6");break;case"何事囧":this.$(".tagStyleList").css("background-color","#FF6138");break;default:console.log(this.model.get("tag"))}}}),itemsView=Backbone.View.extend({model:allContent,el:".mainUl",initialize:function(){this.render()},render:function(){var e=this;return _.each(this.model.toArray(),function(t,n){e.$el.append(new itemView({model:t}).render().$el)}),this}});new itemsView;var commentView=Backbone.View.extend({tagName:"li",template:_.template($("#commentTmp").html()),render:function(){return this.model.save(),"/images/default.png"===this.model.get("cIcon")&&this.model.set("cIcon","default.png"),this.$el.html(this.template(this.model.toJSON())),this}}),haveCommentView=Backbone.View.extend({tagName:"li",template:_.template($("#commentTmp").html()),render:function(){return"/images/default.png"===this.model.cIcon&&(this.model.cIcon="default.png"),this.$el.html(this.template(this.model)),this}}),allContentCache=listModel,paginationView=Backbone.View.extend({tagName:"li",className:"liPage",events:{click:"changePage"},template:_.template($("#pagination").html()),render:function(e){return this.$el.html(this.template({q:e})),this},changePage:function(){allContent.reset(),$(".mainUl li").remove();var e=this.$("a").html()-1,t=allContentCache.slice(e*pinNum,e*pinNum+pinNum);_.each(t,function(e,t){allContent.add(e)}),new itemsView}}),Pagination=Backbone.Collection.extend({createPagination:function(){for(var e=0;e<Math.ceil(allContentCache.length/pinNum);e++)$(".pagination").append((new paginationView).render(e+1).$el)}}),a=new Pagination;a.createPagination();var formSubmit=Backbone.View.extend({el:"#formSubmit",events:{"click input":"submitForm"},submitForm:function(){if("no"===user&&0===ck)alert("请登录后评论");else if(""==$(".form-control").val()||null==$(".form-control").val())alert("评论不能为空");else{var e=new Date,t=e.getFullYear()+"年"+(e.getMonth()+1)+"月"+e.getDate()+"日   "+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes(),n=$(".form-control").val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r?\n/g,"<br />"),o=new itemComment({cIcon:icon,cAuthor:user,cContent:n,cDate:t,_whoseBlog:window.location.hash.substr(6)}),l=new commentView({model:o});$(".commentContainer").prepend(l.render().$el),$(".textSubmit").val("")}}}),blogList=Backbone.View.extend({el:"#blogList",show:function(){this.$el.show()},hide:function(){this.$el.hide()}}),selfBlog=Backbone.View.extend({el:"#selfBlog",template:_.template($("#selfBlogTemp").html()),show:function(){this.model.content=this.model.content.replace(/\r?\n/g,"<br />"),this.model.commentNumber=this.model.comment.length,this.$el.html(this.template(this.model)),this.changeColor(),new formSubmit,_.each(this.model.comment.reverse(),function(e,t){var n=new itemComment;n.url="/helloworld/comment/"+e,n.fetch({success:function(){var e=n.toJSON();$(".commentContainer").append(new haveCommentView({model:e}).render().$el)}})}),this.$el.show()},hide:function(){this.$el.hide()},changeColor:function(){switch(this.model.tag){case"文章":this.$(".tagStyleBlog").css("background-color","#00A388");break;case"问题":this.$(".tagStyleBlog").css("background-color","#e67e22");break;case"学习资料":this.$(".tagStyleBlog").css("background-color","#27ae60");break;case"培训这些事儿":this.$(".tagStyleBlog").css("background-color","#9b59b6");break;case"何事囧":this.$(".tagStyleBlog").css("background-color","#FF6138");break;default:console.log(this.model.get("tag"))}}}),bl=new blogList,sb=null,cgFunction=function(e){if($(".pagination li").remove(),$(".mainUl li").remove(),allContent.reset(),_.each(listModel,function(t,n){t.tag===e&&allContent.add(t)}),allContent.length>10)for(var t=0;t<10;t++)$(".mainUl").append(new itemView({model:allContent.at(t)}).render().$el);else new itemsView;allContentCache=allContent.toArray(),a.createPagination()},myRouter=Backbone.Router.extend({routes:{"":"mainPage","blog/:modelId":"ownerPage",article:"article","q&a":"answer","trade-off":"tradeoff",thingforyou:"thingforyou",ong:"ong"},mainPage:function(){bl.show(),null!==sb&&sb.hide()},ownerPage:function(e){_.each(listModel,function(t,n){t._id===e&&($.get("/helloworld/addRead/"+e),(sb=new selfBlog({model:t})).show(),document.body.scrollTop=document.documentElement.scrollTop=0)}),bl.hide()},article:function(){cgFunction("文章")},answer:function(){cgFunction("问题")},tradeoff:function(){cgFunction("学习资料")},thingforyou:function(){cgFunction("培训这些事儿")},ong:function(){cgFunction("何事囧")}}),router=new myRouter;Backbone.history.start();